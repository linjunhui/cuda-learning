# Grid-Stride Loop è¯¦è§£

## ğŸ¤” ä½ çš„ç–‘é—®è§£ç­”

### ç–‘é—® 1: ä¸ºä»€ä¹ˆä½¿ç”¨ Grid-Stride Loopï¼Ÿ

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ `idx` æ¥è®¿é—®å…ƒç´ ï¼Œè€Œæ˜¯è¦ç”¨å¾ªç¯ï¼Ÿ

```cpp
// ç®€å•æ–¹å¼ï¼ˆé—®é¢˜ç‰ˆæœ¬ï¼‰
int64_t idx = blockIdx.x * blockDim.x + threadIdx.x;
vec[idx] = functor();  // å¦‚æœ N > æ€»çº¿ç¨‹æ•°æ€ä¹ˆåŠï¼Ÿ
```

**é—®é¢˜åœºæ™¯**ï¼š
å‡è®¾æˆ‘ä»¬æœ‰ï¼š
- `N = 10000` ä¸ªå…ƒç´ éœ€è¦å¡«å……
- `gridDim.x = 10` ä¸ª blocks
- `blockDim.x = 256` ä¸ªçº¿ç¨‹/block
- æ€»çº¿ç¨‹æ•° = `10 Ã— 256 = 2560` ä¸ªçº¿ç¨‹

å¦‚æœç”¨ç®€å•æ–¹å¼ï¼Œåªæœ‰å‰ 2560 ä¸ªå…ƒç´ ä¼šè¢«å¤„ç†ï¼åé¢çš„ 7440 ä¸ªå…ƒç´ ä¼šè¢«é—æ¼ï¼

**Grid-Stride Loop çš„ä¼˜åŠ¿**ï¼š
```cpp
int64_t idx = blockIdx.x * blockDim.x + threadIdx.x;
int64_t stride = blockDim.x * gridDim.x;  // stride = 2560
for(int64_t i = idx; i < N; i+=stride) {
    vec[i] = functor();
}
```

- æ¯ä¸ªçº¿ç¨‹å¤„ç†**å¤šä¸ªå…ƒç´ **ï¼ˆä¸æ˜¯åªæœ‰ä¸€ä¸ªï¼‰
- ç¡®ä¿**æ‰€æœ‰å…ƒç´ **éƒ½è¢«å¤„ç†
- æ”¯æŒ**ä»»æ„å¤§å°**çš„æ•°ç»„

---

## ğŸ“Š å·¥ä½œåŸç†è¯¦è§£

### ç¤ºä¾‹ï¼šN=10, blocks=2, threads_per_block=3

**è®¡ç®—**ï¼š
- æ€»çº¿ç¨‹æ•° = `2 Ã— 3 = 6`
- `stride = 6`
- æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„å…ƒç´ æ•° = `âŒˆ10/6âŒ‰ = 2`

**çº¿ç¨‹åˆ†é…**ï¼š

| Thread ID | idx (åˆå§‹) | å¤„ç†çš„å…ƒç´ ç´¢å¼• | è¯´æ˜ |
|-----------|------------|---------------|------|
| Thread 0  | 0          | 0, 6          | i=0, 0+6=6 âœ“ |
| Thread 1  | 1          | 1, 7          | i=1, 1+6=7 âœ“ |
| Thread 2  | 2          | 2, 8          | i=2, 2+6=8 âœ“ |
| Thread 3  | 3          | 3, 9          | i=3, 3+6=9 âœ“ |
| Thread 4  | 4          | 4             | i=4, 4+6=10 âœ— (è¶…å‡ºèŒƒå›´) |
| Thread 5  | 5          | 5             | i=5, 5+6=11 âœ— (è¶…å‡ºèŒƒå›´) |

**ç»“æœ**ï¼šæ‰€æœ‰ 10 ä¸ªå…ƒç´ éƒ½è¢«å¤„ç†äº†ï¼

### å¯è§†åŒ–å›¾è§£

```
æ•°ç»„ç´¢å¼•: [0] [1] [2] [3] [4] [5] [6] [7] [8] [9]
çº¿ç¨‹ 0:    âœ“           âœ“
çº¿ç¨‹ 1:       âœ“           âœ“
çº¿ç¨‹ 2:          âœ“           âœ“
çº¿ç¨‹ 3:             âœ“           âœ“
çº¿ç¨‹ 4:                âœ“
çº¿ç¨‹ 5:                   âœ“
```

---

## ğŸ” å…³é”®ä»£ç è§£æ

### ä»£ç ç‰‡æ®µ

```cpp
__global__ void fill_kernel(T *vec, int64_t N, FillFunctor<T> functor) {
    // 1. è®¡ç®—å½“å‰çº¿ç¨‹çš„å…¨å±€ç´¢å¼•
    int64_t idx = blockIdx.x * blockDim.x + threadIdx.x;
    
    // 2. è®¡ç®— strideï¼ˆæ­¥é•¿ï¼‰= æ€»çº¿ç¨‹æ•°
    // ä¸€ä¸ª grid æœ‰ gridDim.x ä¸ªblock, æ¯ä¸ªblockæœ‰ blockDim.x ä¸ªçº¿ç¨‹
    int64_t stride = blockDim.x * gridDim.x;
    
    // 3. Grid-Stride Loopï¼šæ¯ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªå…ƒç´ 
    for(int64_t i = idx; i < N; i+=stride) {
        vec[i] = functor();
    }
}
```

### é€è¡Œè§£é‡Š

#### ç¬¬ 1 è¡Œï¼šè®¡ç®—çº¿ç¨‹çš„å…¨å±€ç´¢å¼•

```cpp
int64_t idx = blockIdx.x * blockDim.x + threadIdx.x;
```

**å«ä¹‰**ï¼š
- `threadIdx.x`ï¼šçº¿ç¨‹åœ¨ block å†…çš„å±€éƒ¨ç´¢å¼•ï¼ˆ0 åˆ° blockDim.x-1ï¼‰
- `blockIdx.x * blockDim.x`ï¼šå½“å‰ block ä¹‹å‰çš„æ‰€æœ‰çº¿ç¨‹æ•°
- `idx`ï¼šçº¿ç¨‹åœ¨æ•´ä¸ª grid ä¸­çš„å…¨å±€ç´¢å¼•ï¼ˆ0 åˆ° æ€»çº¿ç¨‹æ•°-1ï¼‰

**ç¤ºä¾‹**ï¼š
- Block 0, Thread 2ï¼š`idx = 0 Ã— 256 + 2 = 2`
- Block 1, Thread 2ï¼š`idx = 1 Ã— 256 + 2 = 258`
- Block 2, Thread 2ï¼š`idx = 2 Ã— 256 + 2 = 514`

#### ç¬¬ 2 è¡Œï¼šè®¡ç®— strideï¼ˆæ­¥é•¿ï¼‰

```cpp
int64_t stride = blockDim.x * gridDim.x;
```

**å«ä¹‰**ï¼š
- `stride` = **æ€»çº¿ç¨‹æ•°**
- è¿™æ˜¯ä¸‹ä¸€ä¸ª"è½®æ¬¡"çš„èµ·å§‹ä½ç½®ä¸å½“å‰"è½®æ¬¡"èµ·å§‹ä½ç½®çš„å·®å€¼
- æ¯ä¸ªçº¿ç¨‹æ¯éš” `stride` ä¸ªå…ƒç´ å¤„ç†ä¸€ä¸ª

**ä¸ºä»€ä¹ˆå« strideï¼Ÿ**
- æƒ³è±¡æ‰€æœ‰çº¿ç¨‹å¹¶æ’å¤„ç†æ•°ç»„
- ç¬¬ä¸€è½®ï¼šçº¿ç¨‹ 0 å¤„ç†å…ƒç´  0ï¼Œçº¿ç¨‹ 1 å¤„ç†å…ƒç´  1ï¼Œ...
- ç¬¬äºŒè½®ï¼šçº¿ç¨‹ 0 å¤„ç†å…ƒç´  `stride`ï¼Œçº¿ç¨‹ 1 å¤„ç†å…ƒç´  `stride+1`ï¼Œ...
- è¿™å°±æ˜¯"æ­¥é•¿"çš„å«ä¹‰

#### ç¬¬ 3 è¡Œï¼šGrid-Stride Loop

```cpp
for(int64_t i = idx; i < N; i+=stride) {
    vec[i] = functor();
}
```

**å«ä¹‰**ï¼š
- ä»å½“å‰çº¿ç¨‹çš„åˆå§‹ç´¢å¼• `idx` å¼€å§‹
- æ¯æ¬¡å¢åŠ  `stride`ï¼ˆå³æ€»çº¿ç¨‹æ•°ï¼‰
- ç»§ç»­ç›´åˆ°è¶…è¿‡æ•°ç»„å¤§å° `N`
- æ¯ä¸ªçº¿ç¨‹å¤„ç†ï¼š`idx, idx+stride, idx+2*stride, ...`

**æ•°å­¦è¡¨è¾¾**ï¼š
çº¿ç¨‹ `t` å¤„ç†çš„å…ƒç´ ç´¢å¼• = `{t, t+stride, t+2*stride, ...}` ä¸” `< N`

---

## ğŸ’¡ å¸¸è§ç–‘é—®è§£ç­”

### Q1: ä¸ºä»€ä¹ˆ stride = blockDim.x * gridDim.xï¼Ÿ

**A**: å› ä¸ºè¿™æ˜¯æ€»çº¿ç¨‹æ•°ã€‚æ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªå…ƒç´ ï¼Œä¸‹ä¸€è½®æ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥æ­¥é•¿å°±æ˜¯çº¿ç¨‹æ€»æ•°ã€‚

**å›¾è§£**ï¼š
```
çº¿ç¨‹æ•° = 6, stride = 6
æ•°ç»„: [0][1][2][3][4][5][6][7][8][9][10][11]

ç¬¬ä¸€è½®ï¼š
T0->0, T1->1, T2->2, T3->3, T4->4, T5->5

ç¬¬äºŒè½®ï¼ˆæ¯ä¸ªçº¿ç¨‹ + strideï¼‰ï¼š
T0->6, T1->7, T2->8, T3->9, T4->10, T5->11
```

### Q2: æ¯ä¸ªçº¿ç¨‹å¤„ç†å¤šå°‘ä¸ªå…ƒç´ ï¼Ÿ

**A**: æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„å…ƒç´ æ•° = `âŒˆ(N - idx) / strideâŒ‰`

**ç¤ºä¾‹**ï¼š
- `N=10000`, `idx=0`, `stride=2560`
  - çº¿ç¨‹ 0 å¤„ç†ï¼š`âŒˆ(10000-0)/2560âŒ‰ = âŒˆ3.9âŒ‰ = 4` ä¸ªå…ƒç´ 
  - å…ƒç´ ç´¢å¼•ï¼š0, 2560, 5120, 7680
  
- `N=10000`, `idx=2560`, `stride=2560`
  - çº¿ç¨‹ 2560 å¤„ç†ï¼š`âŒˆ(10000-2560)/2560âŒ‰ = âŒˆ2.9âŒ‰ = 3` ä¸ªå…ƒç´ 
  - å…ƒç´ ç´¢å¼•ï¼š2560, 5120, 7680

### Q3: ä¼šä¸ä¼šæœ‰é‡å¤å¤„ç†æˆ–é—æ¼ï¼Ÿ

**A**: ä¸ä¼šï¼

**è¯æ˜**ï¼š
1. **ä¸é‡å¤**ï¼šæ¯ä¸ªçº¿ç¨‹çš„èµ·å§‹ `idx` ä¸åŒï¼Œä¸”æ¯æ¬¡å¢åŠ ç›¸åŒçš„ `stride`ï¼Œæ‰€ä»¥å¤„ç†çš„ç´¢å¼•ä¸ä¼šé‡å 
2. **ä¸é—æ¼**ï¼šä» 0 åˆ° N-1 çš„æ‰€æœ‰ç´¢å¼•éƒ½èƒ½è¢«æŸä¸ªçº¿ç¨‹è®¿é—®åˆ°

**å½¢å¼åŒ–è¯æ˜**ï¼š
å¯¹äºä»»æ„ç´¢å¼• `i` (0 â‰¤ i < N)ï¼Œå®ƒä¼šè¢«çº¿ç¨‹ `t = i % stride` å¤„ç†ï¼š
- ç¬¬ä¸€è½®ï¼š`t = i % stride` â†’ å¦‚æœ `i < stride`ï¼Œåœ¨ç¬¬ä¸€è½®å¤„ç†
- åç»­è½®ï¼šå¦‚æœ `i â‰¥ stride`ï¼Œä¼šåœ¨ `âŒŠi/strideâŒ‹` è½®è¢«çº¿ç¨‹ `t` å¤„ç†

### Q4: æ€§èƒ½å¦‚ä½•ï¼Ÿä¼šä¸ä¼šæ¯”ç®€å•æ–¹å¼æ…¢ï¼Ÿ

**A**: å¯¹äºå°æ•°ç»„ï¼Œå¯èƒ½ç•¥æ…¢ï¼›å¯¹äºå¤§æ•°ç»„ï¼Œæ€§èƒ½ç›¸åŒç”šè‡³æ›´å¥½ã€‚

**åŸå› **ï¼š
- **ç®€å•æ–¹å¼**ï¼šéœ€è¦å¯åŠ¨ `âŒˆN/threads_per_blockâŒ‰` ä¸ª blocks
  - å¦‚æœ `N=10^9`ï¼Œéœ€è¦ `âŒˆ10^9/256âŒ‰ = 3,906,250` ä¸ª blocksï¼
  - CUDA æœ‰ block æ•°é‡é™åˆ¶ï¼ˆé€šå¸¸æ˜¯ 65535ï¼‰
- **Grid-Stride Loop**ï¼šåªéœ€è¦å¯åŠ¨å›ºå®šçš„ blocksï¼ˆæ¯”å¦‚ 1024ï¼‰
  - æ¯ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªå…ƒç´ ï¼Œé¿å…äº† block æ•°é‡é™åˆ¶
  - æ›´å¥½çš„è´Ÿè½½å‡è¡¡

---

## ğŸ”„ ä¸ä¼ ç»Ÿæ–¹å¼å¯¹æ¯”

### ä¼ ç»Ÿæ–¹å¼ï¼ˆæœ‰é™åˆ¶ï¼‰

```cpp
__global__ void fill_kernel_naive(T *vec, int64_t N, T value) {
    int64_t idx = blockIdx.x * blockDim.x + threadIdx.x;
    if (idx < N) {  // è¾¹ç•Œæ£€æŸ¥
        vec[idx] = value;
    }
    // é—®é¢˜ï¼šå¦‚æœ N > æ€»çº¿ç¨‹æ•°ï¼Œæœ‰äº›å…ƒç´ ä¸ä¼šè¢«å¤„ç†ï¼
}
```

**é™åˆ¶**ï¼š
- å¦‚æœ `N = 10000` ä½†åªæœ‰ `2560` ä¸ªçº¿ç¨‹ï¼Œåé¢ `7440` ä¸ªå…ƒç´ ä¼šè¢«é—æ¼
- éœ€è¦å¯åŠ¨ `âŒˆN/256âŒ‰` ä¸ª blocksï¼Œå¯èƒ½æœ‰æ•°é‡é™åˆ¶

### Grid-Stride Loopï¼ˆæ¨èï¼‰

```cpp
__global__ void fill_kernel(T *vec, int64_t N, FillFunctor<T> functor) {
    int64_t idx = blockIdx.x * blockDim.x + threadIdx.x;
    int64_t stride = blockDim.x * gridDim.x;
    for(int64_t i = idx; i < N; i+=stride) {
        vec[i] = functor();
    }
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ”¯æŒä»»æ„å¤§å°çš„æ•°ç»„
- âœ… æ¯ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªå…ƒç´ ï¼Œè‡ªåŠ¨è´Ÿè½½å‡è¡¡
- âœ… é¿å…äº† block æ•°é‡é™åˆ¶
- âœ… ä»£ç ç®€æ´ï¼Œä¸éœ€è¦è¾¹ç•Œæ£€æŸ¥

---

## ğŸ“ å®é™…ç¤ºä¾‹

### ç¤ºä¾‹ 1: N=100, blocks=4, threads_per_block=64

```
æ€»çº¿ç¨‹æ•° = 4 Ã— 64 = 256
stride = 256
æ¯ä¸ªçº¿ç¨‹å¤„ç†å…ƒç´ æ•° = âŒˆ100/256âŒ‰ = 1 (å‰100ä¸ªçº¿ç¨‹)ï¼Œ0 (å156ä¸ªçº¿ç¨‹)
```

**çº¿ç¨‹å¤„ç†æƒ…å†µ**ï¼š
- çº¿ç¨‹ 0-99ï¼šå¤„ç†å…ƒç´  0-99ï¼ˆå„å¤„ç† 1 ä¸ªï¼‰
- çº¿ç¨‹ 100-255ï¼šä¸å¤„ç†ä»»ä½•å…ƒç´ ï¼ˆå¾ªç¯æ¡ä»¶ `i < N` ç«‹å³å¤±è´¥ï¼‰

### ç¤ºä¾‹ 2: N=10000, blocks=4, threads_per_block=256

```
æ€»çº¿ç¨‹æ•° = 4 Ã— 256 = 1024
stride = 1024
æ¯ä¸ªçº¿ç¨‹å¤„ç†å…ƒç´ æ•° â‰ˆ âŒˆ10000/1024âŒ‰ = 10
```

**çº¿ç¨‹å¤„ç†æƒ…å†µ**ï¼š
- çº¿ç¨‹ 0ï¼šå¤„ç†å…ƒç´  0, 1024, 2048, 3072, 4096, 5120, 6144, 7168, 8192, 9216
- çº¿ç¨‹ 1ï¼šå¤„ç†å…ƒç´  1, 1025, 2049, 3073, 4097, 5121, 6145, 7169, 8193, 9217
- ...
- çº¿ç¨‹ 1023ï¼šå¤„ç†å…ƒç´  1023, 2047, 3071, 4095, 5119, 6143, 7167, 8191, 9215, 10239ï¼ˆæœ€åä¸€ä¸ªæ˜¯è¾¹ç•Œæ£€æŸ¥å¤±è´¥ï¼‰

### ç¤ºä¾‹ 3: N=1000, blocks=1024, threads_per_block=256

```
æ€»çº¿ç¨‹æ•° = 1024 Ã— 256 = 262144
stride = 262144
æ¯ä¸ªçº¿ç¨‹å¤„ç†å…ƒç´ æ•° = âŒˆ1000/262144âŒ‰ = 1 (åªæœ‰å‰1000ä¸ªçº¿ç¨‹)ï¼Œ0 (å…¶ä»–çº¿ç¨‹)
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. Block æ•°é‡é€‰æ‹©

```cpp
// æ¨èçš„ block é…ç½®
const int threads_per_block = 256;
const int max_blocks = 1024;
int blocks = (N + threads_per_block - 1) / threads_per_block;
blocks = blocks < max_blocks ? blocks : max_blocks;  // é™åˆ¶æœ€å¤§ blocks
```

**åŸå› **ï¼š
- å¤ªå°‘ blocksï¼šå¹¶è¡Œåº¦ä¸è¶³
- å¤ªå¤š blocksï¼šèµ„æºæµªè´¹ï¼Œå¯èƒ½è¾¾åˆ°ç¡¬ä»¶é™åˆ¶
- æ¨èï¼šæ ¹æ®æ•°ç»„å¤§å°åŠ¨æ€è°ƒæ•´ï¼Œä½†ä¸è¶…è¿‡ 1024

### 2. ä¸ºä»€ä¹ˆé™åˆ¶ max_blocksï¼Ÿ

```cpp
// å¦‚æœä¸é™åˆ¶
int blocks = (1000000000 + 256 - 1) / 256;  // = 3,906,250 ä¸ª blocks

// é—®é¢˜ï¼š
// 1. GPU ç¡¬ä»¶é™åˆ¶ï¼ˆé€šå¸¸æ˜¯ 65535ï¼‰
// 2. å†…å­˜å’Œèµ„æºæµªè´¹
// 3. Grid-Stride Loop å°±æ˜¯ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼
```

### 3. å®Œæ•´çš„ä¸»æœºç«¯è°ƒç”¨ä»£ç 

```cpp
template<typename T>
void fill_cuda(T* d_output, int64_t N, T value) {
    if (N == 0) return;
    
    // é…ç½® kernel å‚æ•°
    const int threads_per_block = 256;
    const int max_blocks = 1024;
    int blocks = (N + threads_per_block - 1) / threads_per_block;
    blocks = blocks < max_blocks ? blocks : max_blocks;
    
    // åˆ›å»º Functor
    FillFunctor<T> functor(value);
    
    // å¯åŠ¨ kernelï¼ˆGrid-Stride Loop ä¼šå¤„ç†æ‰€æœ‰å…ƒç´ ï¼‰
    fill_kernel<<<blocks, threads_per_block>>>(d_output, N, functor);
    
    // æ£€æŸ¥é”™è¯¯
    cudaError_t err = cudaGetLastError();
    if (err != cudaSuccess) {
        fprintf(stderr, "CUDA error: %s\n", cudaGetErrorString(err));
    }
}
```

---

## ğŸ“š æ€»ç»“

### Grid-Stride Loop çš„æ ¸å¿ƒæ€æƒ³

1. **æ¯ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªå…ƒç´ **ï¼šä¸æ˜¯ 1:1 æ˜ å°„
2. **æ­¥é•¿ = æ€»çº¿ç¨‹æ•°**ï¼šç¡®ä¿ä¸é‡å¤ä¸é—æ¼
3. **æ”¯æŒä»»æ„å¤§å°**ï¼šä¸å— block æ•°é‡é™åˆ¶
4. **è´Ÿè½½å‡è¡¡**ï¼šæ¯ä¸ªçº¿ç¨‹çš„å·¥ä½œé‡ç›¸è¿‘

### è®°å¿†å£è¯€

> **"æ¯ä¸ªçº¿ç¨‹èµ°å¤§æ­¥ï¼Œæ­¥é•¿ç­‰äºæ€»çº¿ç¨‹æ•°ï¼Œä¸€ç›´èµ°åˆ°æ•°ç»„å°¾ï¼Œä¸é‡å¤æ¥ä¸é—æ¼"**

### ä½•æ—¶ä½¿ç”¨ Grid-Stride Loopï¼Ÿ

âœ… **æ¨èä½¿ç”¨**ï¼š
- å¤„ç†ä»»æ„å¤§å°çš„æ•°ç»„
- éœ€è¦ä¿è¯æ‰€æœ‰å…ƒç´ éƒ½è¢«å¤„ç†
- é¿å… block æ•°é‡é™åˆ¶

âŒ **å¯ä»¥ä½¿ç”¨ç®€å•æ–¹å¼**ï¼š
- æ•°ç»„å¾ˆå°ï¼ˆ< æ€»çº¿ç¨‹æ•°ï¼‰
- ä¸éœ€è¦è€ƒè™‘æ‰©å±•æ€§
- æ•™å­¦æ¼”ç¤ºï¼ˆç®€å•æ˜“æ‡‚ï¼‰

---

## ğŸ”— å‚è€ƒèµ„æº

- [NVIDIA CUDA æœ€ä½³å®è·µï¼šGrid-Stride Loop](https://developer.nvidia.com/blog/cuda-pro-tip-write-flexible-kernels-grid-stride-loops/)
- [PyTorch CUDA ç®—å­å®ç°è¯¦è§£](../CUDAç®—å­å®ç°è¯¦è§£.md)
- [CUDA C++ Programming Guide](https://docs.nvidia.com/cuda/cuda-c-programming-guide/)

