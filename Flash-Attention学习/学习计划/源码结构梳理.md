# Flash-Attention æºç ç»“æ„æ¢³ç†

## ğŸ“ æ ¸å¿ƒç›®å½•ç»“æ„

### 1. Python æ¥å£å±‚

**è·¯å¾„**ï¼š`flash_attn/`

**å…³é”®æ–‡ä»¶**ï¼š
- `flash_attn_interface.py` - ä¸»è¦æ¥å£
- `flash_attn_triton.py` - Triton å®ç°
- `modules/flash_attn.py` - PyTorch æ¨¡å—å°è£…

**åŠŸèƒ½**ï¼š
- æä¾› Python API
- å‚æ•°éªŒè¯å’Œè½¬æ¢
- è°ƒç”¨ CUDA å†…æ ¸

---

### 2. CUDA æ ¸å¿ƒå®ç°ï¼ˆFlash-Attention 2ï¼‰

**è·¯å¾„**ï¼š`csrc/flash_attn/src/`

#### 2.1 å¤´æ–‡ä»¶ç»“æ„

| æ–‡ä»¶ | åŠŸèƒ½ | é‡è¦æ€§ |
|------|------|--------|
| `flash.h` | å‚æ•°ç»“æ„å®šä¹‰ | â­â­â­â­â­ |
| `flash_fwd_kernel.h` | å‰å‘ä¼ æ’­å†…æ ¸ | â­â­â­â­â­ |
| `flash_bwd_kernel.h` | åå‘ä¼ æ’­å†…æ ¸ | â­â­â­â­â­ |
| `flash_fwd_launch_template.h` | å‰å‘å†…æ ¸å¯åŠ¨ | â­â­â­â­ |
| `flash_bwd_launch_template.h` | åå‘å†…æ ¸å¯åŠ¨ | â­â­â­â­ |
| `kernel_traits.h` | å†…æ ¸ç‰¹æ€§å®šä¹‰ | â­â­â­â­ |
| `softmax.h` | Softmax å®ç° | â­â­â­â­â­ |
| `mask.h` | æ©ç å¤„ç† | â­â­â­ |
| `dropout.h` | Dropout å®ç° | â­â­â­ |
| `rotary.h` | RoPE ä½ç½®ç¼–ç  | â­â­â­ |
| `block_info.h` | å—ä¿¡æ¯ç®¡ç† | â­â­â­ |
| `utils.h` | å·¥å…·å‡½æ•° | â­â­ |

#### 2.2 å®ç°æ–‡ä»¶ç»“æ„

**å‰å‘ä¼ æ’­å®ç°**ï¼š
- `flash_fwd_hdim{32,64,96,128,192,256}_{fp16,bf16}_{causal,}_sm80.cu`
  - ä¸åŒ head_dim å’Œæ•°æ®ç±»å‹çš„å‰å‘å®ç°
  - `causal` è¡¨ç¤ºå› æœæ³¨æ„åŠ›

**åå‘ä¼ æ’­å®ç°**ï¼š
- `flash_bwd_hdim{32,64,96,128,192,256}_{fp16,bf16}_{causal,}_sm80.cu`
  - ä¸åŒé…ç½®çš„åå‘å®ç°

**Split-KV å®ç°**ï¼š
- `flash_fwd_split_hdim{...}.cu`
  - Split-KV ä¼˜åŒ–çš„å‰å‘å®ç°

---

### 3. Flash-Attention 3 (H100)

**è·¯å¾„**ï¼š`hopper/`

**å…³é”®æ–‡ä»¶**ï¼š
- `flash_fwd_kernel_sm90.h` - SM90 å‰å‘å†…æ ¸
- `flash_bwd_kernel_sm90.h` - SM90 åå‘å†…æ ¸
- `flash_attn_interface.py` - Python æ¥å£

**ç‰¹æ€§**ï¼š
- FP8 æ•°æ®ç±»å‹æ”¯æŒ
- Paged Attention
- Split-KV ä¼˜åŒ–
- Softcap æ³¨æ„åŠ›

---

### 4. ä¾èµ–åº“

**CUTLASS**ï¼š
- `csrc/cutlass/` - GEMM ä¼˜åŒ–åº“

**CuTe**ï¼š
- `csrc/cutlass/cute/` - å¼ é‡æŠ½è±¡åº“

**Composable Kernel**ï¼š
- `csrc/composable_kernel/` - å¯ç»„åˆå†…æ ¸åº“

---

## ğŸ” å…³é”®æ•°æ®ç»“æ„

### Flash_fwd_params

**å®šä¹‰ä½ç½®**ï¼š`csrc/flash_attn/src/flash.h`

**å…³é”®å­—æ®µ**ï¼š
```cuda
struct Flash_fwd_params : public Qkv_params {
    // QKV çŸ©é˜µæŒ‡é’ˆå’Œæ­¥é•¿
    void *q_ptr, *k_ptr, *v_ptr;
    int64_t q_batch_stride, k_batch_stride, v_batch_stride;
    int64_t q_row_stride, k_row_stride, v_row_stride;
    int64_t q_head_stride, k_head_stride, v_head_stride;
    
    // è¾“å‡ºçŸ©é˜µ
    void *o_ptr;
    int64_t o_batch_stride, o_row_stride, o_head_stride;
    
    // Softmax ç›¸å…³
    void *softmax_lse_ptr;  // Log-sum-exp å€¼
    void *p_ptr;            // æ³¨æ„åŠ›æƒé‡ï¼ˆå¯é€‰ï¼‰
    
    // ç»´åº¦ä¿¡æ¯
    int b;      // batch size
    int h;      // num heads
    int h_k;    // num heads for K/V (GQA)
    int seqlen_q, seqlen_k;
    int d;      // head dimension
    
    // å…¶ä»–å‚æ•°
    float p_dropout;
    float softcap;
    float scale;
    // ...
};
```

---

### Flash_fwd_kernel_traits

**å®šä¹‰ä½ç½®**ï¼š`csrc/flash_attn/src/kernel_traits.h`

**å…³é”®é…ç½®**ï¼š
```cuda
template<int kHeadDim_, int kBlockM_, int kBlockN_, int kNWarps_, ...>
struct Flash_fwd_kernel_traits {
    // æ•°æ®ç±»å‹
    using Element = cutlass::half_t;
    using ElementAccum = float;
    
    // å—å¤§å°
    static constexpr int kBlockM = kBlockM_;  // Q çš„å—å¤§å°
    static constexpr int kBlockN = kBlockN_;  // K/V çš„å—å¤§å°
    static constexpr int kHeadDim = kHeadDim_;
    
    // Warp é…ç½®
    static constexpr int kNWarps = kNWarps_;
    static constexpr int kNThreads = kNWarps * 32;
    
    // å†…å­˜å¸ƒå±€
    using SmemLayoutQ = ...;
    using SmemLayoutK = ...;
    using SmemLayoutV = ...;
    
    // GEMM é…ç½®
    using TiledMma = ...;
};
```

**å¸¸è§é…ç½®**ï¼š
- `kHeadDim = 64/128/192/256`
- `kBlockM = 64/128`
- `kBlockN = 64/128`
- `kNWarps = 4/8`

---

## ğŸ”„ ä»£ç è°ƒç”¨æµç¨‹

### å‰å‘ä¼ æ’­è°ƒç”¨æµç¨‹

```
Python å±‚
  â†“
flash_attn_interface.py::flash_attn_func()
  â†“
flash_fwd_launch_template.h::run_flash_fwd()
  â†“
flash_fwd_kernel.h::flash_fwd_kernel()
  â†“
flash_fwd_kernel.h::compute_attn()
  â†“
flash_fwd_kernel.h::compute_attn_1rowblock()
  â†“
  â”œâ”€ softmax.h::reduce_max()
  â”œâ”€ softmax.h::scale_apply_exp2()
  â”œâ”€ softmax.h::reduce_sum()
  â””â”€ CUTLASS GEMM
```

### å…³é”®å‡½æ•°è°ƒç”¨é“¾

1. **å†…æ ¸å¯åŠ¨**ï¼š
   ```cuda
   run_flash_fwd<Kernel_traits, Is_dropout, Is_causal>()
     â†’ flash_fwd_kernel<<<grid, threads, smem>>>(params)
   ```

2. **ä¸»è®¡ç®—å‡½æ•°**ï¼š
   ```cuda
   compute_attn<Kernel_traits, ...>()
     â†’ for each m_block:
         compute_attn_1rowblock<Kernel_traits, ...>()
   ```

3. **å•è¡Œå—è®¡ç®—**ï¼š
   ```cuda
   compute_attn_1rowblock()
     â†’ Load Q block
     â†’ for each n_block:
         â†’ Load K, V block
         â†’ Compute QK^T
         â†’ Online Softmax
         â†’ Compute PV
         â†’ Update output
   ```

---

## ğŸ“Š å†…æ ¸é…ç½®åˆ†æ

### ç½‘æ ¼é…ç½®

```cuda
// å‰å‘ä¼ æ’­ç½‘æ ¼é…ç½®
int num_m_block = (seqlen_q + kBlockM - 1) / kBlockM;
dim3 grid(num_m_block, batch_size, num_heads);
```

**è¯´æ˜**ï¼š
- `grid.x`ï¼šQ çš„å—æ•°é‡
- `grid.y`ï¼šbatch size
- `grid.z`ï¼šhead æ•°é‡

### çº¿ç¨‹å—é…ç½®

```cuda
dim3 threads(kNThreads);  // kNThreads = kNWarps * 32
```

**è¯´æ˜**ï¼š
- æ¯ä¸ªçº¿ç¨‹å—åŒ…å« `kNWarps` ä¸ª warp
- æ¯ä¸ª warp 32 ä¸ªçº¿ç¨‹

### å…±äº«å†…å­˜é…ç½®

```cuda
constexpr size_t smem_size = Kernel_traits::kSmemSize;
```

**è¯´æ˜**ï¼š
- å­˜å‚¨ Qã€Kã€V å—
- å¤§å°å–å†³äº `kBlockM`ã€`kBlockN`ã€`kHeadDim`

---

## ğŸ¯ å­¦ä¹ ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ç†è§£ï¼‰

1. **flash.h** - å‚æ•°ç»“æ„
2. **flash_fwd_kernel.h** - å‰å‘å†…æ ¸
3. **softmax.h** - Softmax å®ç°
4. **flash_fwd_launch_template.h** - å†…æ ¸å¯åŠ¨

### ä¸­ä¼˜å…ˆçº§ï¼ˆé‡è¦ç†è§£ï¼‰

1. **kernel_traits.h** - å†…æ ¸ç‰¹æ€§
2. **block_info.h** - å—ä¿¡æ¯
3. **mask.h** - æ©ç å¤„ç†
4. **flash_bwd_kernel.h** - åå‘å†…æ ¸

### ä½ä¼˜å…ˆçº§ï¼ˆäº†è§£å³å¯ï¼‰

1. **dropout.h** - Dropout å®ç°
2. **rotary.h** - RoPE å®ç°
3. **utils.h** - å·¥å…·å‡½æ•°

---

## ğŸ“ å­¦ä¹ å»ºè®®

### å­¦ä¹ é¡ºåº

1. **å…ˆç†è§£æ•´ä½“ç»“æ„**
   - é˜…è¯» `flash.h` äº†è§£å‚æ•°
   - é˜…è¯» `flash_fwd_launch_template.h` äº†è§£å¯åŠ¨æµç¨‹

2. **æ·±å…¥æ ¸å¿ƒç®—æ³•**
   - é˜…è¯» `flash_fwd_kernel.h` ç†è§£ä¸»æµç¨‹
   - é˜…è¯» `softmax.h` ç†è§£ Online Softmax

3. **ç†è§£ä¼˜åŒ–æŠ€æœ¯**
   - åˆ†æå†…å­˜è®¿é—®æ¨¡å¼
   - ç†è§£ CUTLASS é›†æˆ

4. **æ‰©å±•åˆ°å…¶ä»–éƒ¨åˆ†**
   - å­¦ä¹ åå‘ä¼ æ’­
   - å­¦ä¹ å…¶ä»–å˜ä½“

### å­¦ä¹ æ–¹æ³•

1. **ä»£ç é˜…è¯»**ï¼š
   - ä»å…¥å£å‡½æ•°å¼€å§‹
   - è¿½è¸ªå‡½æ•°è°ƒç”¨é“¾
   - ç†è§£æ•°æ®æµ

2. **è°ƒè¯•åˆ†æ**ï¼š
   - ä½¿ç”¨ `printf` æ·»åŠ è°ƒè¯•ä¿¡æ¯
   - ä½¿ç”¨ Nsight Compute åˆ†æ
   - å¯¹æ¯”ä¸åŒé…ç½®çš„æ€§èƒ½

3. **å®è·µç»ƒä¹ **ï¼š
   - å®ç°ç®€åŒ–ç‰ˆæœ¬
   - ä¿®æ”¹å‚æ•°è§‚å¯Ÿæ•ˆæœ
   - å°è¯•ä¼˜åŒ–

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**ï¼š2024å¹´  
**æœ€åæ›´æ–°**ï¼š2024å¹´
